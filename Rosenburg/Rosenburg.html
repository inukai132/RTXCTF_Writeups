<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>writeup</title>
  <link rel="stylesheet" href="https://stackedit.io/style.css" />
</head>

<body class="stackedit">
  <div class="stackedit__html"><h1 id="rosenburg---crypto-500">Rosenburg - Crypto 500</h1>
<blockquote>
<p>They should already know intended solutions mean nothing to us - sine_nomine</p>
</blockquote>
<h2 id="challenge-description">Challenge Description</h2>
<p>In that file you found from the hash system we saw something referring to “Rosenberg” with another network service to connect to, this one is a bit strange, we know the communicatons are encrypted but we can’t figure out how to break them maybe you’ll have better luck with this one?</p>
<p>NOTE: Rosenberg is the creator of the challenge, it’s not a hint towards anything.</p>
<p>Connect here:</p>
<p>nc 172.18.10.105 30303</p>
<h2 id="initial-observations">Initial Observations</h2>
<p>Connecting to the server, we get a ciphertext and are asked to send one back. Echoing back the ciphertext (without the 0x) we get <code>correct padding</code>. Removing a few bytes and sending it back gives us <code>wrong padding</code>. This server is vulnerable to a Padding Oracle attack.</p>
<h2 id="padding-oracle">Padding Oracle</h2>
<p>The Padding Oracle attack is an attack against block-mode crypto systems (Like AES-CBC). In order to work, block ciphers need the input to be divisible by a certain number (Usually the length of the key). The way they accomplish this is with an algorithm called PKCS7.</p>
<h3 id="padding">Padding</h3>
<p>In a nutshell, you take the number of bytes you need to pad, lets call this number N, and you add N to the end of your message until it’s the correct size. If you need no padding, N becomes the key size and you add N N’s to the end. So if your message is “Hello” and needs to be padded to 8 bytes, it would be “Hello\x03\x03\x03”. If your message was “Padding!” then you would add 8 0x08 and get “Padding!\x08\x08\x08\x08\x08\x08\x08\x08”. This way the other end always knows how much padding to strip from the message.</p>
<h3 id="oracle">Oracle</h3>
<p>This required padding causes some information to be leaked if the error messages tell you when there was a padding error. A padding error means that after decryption, the message looked like this “Message!\x03\x03” The number of padding bytes doesn’t match the value of the padding bytes. This means if we have an oracle that tells us that the padding was wrong, we can leak information about the actual message.</p>
<h3 id="attack">Attack</h3>
<p>How can we use this to leak information? Well think back to how block ciphers decrypt data.<br>
<img src="images/Cbc_decryption.png" alt="CBC Mode Graph"><br>
The plaintext of the last block is directly controlled by the ciphertext of the previous block. If you’re more mathematically inclined you can think of it like this.</p>
<pre class=" language-c"><code class="prism  language-c">Cn <span class="token comment">//Last block of ciphertext</span>
Cp <span class="token comment">//Previous block of ciphertext</span>
In <span class="token operator">=</span> <span class="token function">decrypt</span><span class="token punctuation">(</span>Cn<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token comment">//The intermediate is the result of decrypting the last block with the unknown key</span>
Pn <span class="token operator">=</span> Cp <span class="token operator">^</span> In <span class="token comment">//The last block of plaintext is the previous ciphertext XOR with the intermediate.</span>
</code></pre>
<p>We control Cp, and we know we will get an error whenever Pn is badly padded. We can change the last byte of Cp one byte at a time and find one that gives us good padding. Once we know that the padding is good, we will know that the padding must be 0x01 since we only changed one byte.</p>
<pre class=" language-c"><code class="prism  language-c">P`n <span class="token operator">=</span> <span class="token number">0x1</span><span class="token comment">//The last byte of the modified plaintext</span>
P`n <span class="token operator">=</span> C`p <span class="token operator">^</span> In <span class="token comment">//In hasn't changed from before since the last block is the same</span>
In <span class="token operator">=</span> C`p <span class="token operator">^</span> P`n <span class="token operator">=</span> C`p <span class="token operator">^</span> <span class="token number">0x01</span> <span class="token comment">//We can get the real value of In by XORing the controlled C`p and the current padding 0x01</span>
Pn <span class="token operator">=</span> Cp <span class="token operator">^</span> In <span class="token comment">//Now that we know In we can substitute the original Cp to get the original Pn</span>
</code></pre>
<p>Then we just need to repeat this for every byte of the block, increasing the padding from \x01 to \x02\x02 to \x03\x03\x03 and so on. When we solved every byte of the block, we can just remove the last block and repeat the procedure with the new last block.</p>
<h2 id="exploit">Exploit</h2>
<p>First steps are just grabbing the ciphertext from the server and splitting them into a list of bytes. I kept them as str to make it easier to join them and send them in the loop. I also guessed a seemingly good block size of 16 bytes. The loop is done in 3 stages, The k loop will take two blocks and separate them into an oracle and padding. Then the j loops for each byte in the block, testing every possible byte value in the i loop. For each test we will send the oracleBlock+paddingBlock. We will initially skip bytes that are the same since that can lead to false positives. If we don’t find another candidate then we will use the skipped byte.</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">import</span> sys

good <span class="token operator">=</span> b<span class="token string">"\x00\x00correct padding"</span>
bad <span class="token operator">=</span>  b<span class="token string">"\x00\x00wrong padding"</span>
blockSize <span class="token operator">=</span> <span class="token number">16</span>
con <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'172.18.10.105'</span><span class="token punctuation">,</span> <span class="token number">30303</span><span class="token punctuation">)</span>
target <span class="token operator">=</span> con<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span>b<span class="token string">'x'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>F<span class="token string">"Got target: 0x{target}"</span><span class="token punctuation">)</span>
originalList <span class="token operator">=</span> <span class="token punctuation">[</span>target<span class="token punctuation">[</span>i<span class="token punctuation">:</span>i<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'ascii'</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token builtin">len</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>F<span class="token string">"Got originalList: {originalList}"</span><span class="token punctuation">)</span>
out <span class="token operator">=</span> b<span class="token string">''</span>

<span class="token keyword">for</span> k <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>originalList<span class="token punctuation">)</span><span class="token operator">//</span>blockSize<span class="token number">-1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
  intermediates <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">*</span>blockSize
  originalOracle <span class="token operator">=</span> originalList<span class="token punctuation">[</span><span class="token number">16</span><span class="token operator">*</span><span class="token punctuation">(</span>k<span class="token number">-1</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token number">16</span><span class="token operator">*</span>k<span class="token punctuation">]</span>
  oracleBlock <span class="token operator">=</span> originalList<span class="token punctuation">[</span><span class="token number">16</span><span class="token operator">*</span><span class="token punctuation">(</span>k<span class="token number">-1</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token number">16</span><span class="token operator">*</span>k<span class="token punctuation">]</span>
  blockOut <span class="token operator">=</span> b<span class="token string">''</span>
  paddingBlock <span class="token operator">=</span> originalList<span class="token punctuation">[</span><span class="token number">16</span><span class="token operator">*</span>k<span class="token punctuation">:</span><span class="token number">16</span><span class="token operator">*</span><span class="token punctuation">(</span>k<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
  
  <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>blockSize<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
      <span class="token keyword">if</span> i <span class="token operator">==</span> <span class="token builtin">int</span><span class="token punctuation">(</span>originalOracle<span class="token punctuation">[</span><span class="token operator">-</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>F<span class="token string">"Skipping check of same value {hex(i)}"</span><span class="token punctuation">)</span>
        <span class="token keyword">continue</span>
      con<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"ciphertext"</span><span class="token punctuation">)</span>
      oracleBlock<span class="token punctuation">[</span><span class="token operator">-</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"%02x"</span><span class="token operator">%</span>i
      con<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>oracleBlock<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>paddingBlock<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      status <span class="token operator">=</span> con<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> status <span class="token operator">==</span> good<span class="token punctuation">:</span>
        intermediates<span class="token punctuation">[</span><span class="token operator">-</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> i <span class="token operator">^</span> j
        blockOut <span class="token operator">=</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token punctuation">[</span> intermediates<span class="token punctuation">[</span><span class="token operator">-</span>j<span class="token punctuation">]</span> <span class="token operator">^</span> <span class="token builtin">int</span><span class="token punctuation">(</span>originalOracle<span class="token punctuation">[</span><span class="token operator">-</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> blockOut
        <span class="token keyword">for</span> k <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">:</span>
          oracleBlock<span class="token punctuation">[</span><span class="token operator">-</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span>k<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"%02x"</span><span class="token operator">%</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>oracleBlock<span class="token punctuation">[</span><span class="token operator">-</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span>k<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">^</span> j <span class="token operator">^</span> <span class="token punctuation">(</span>j<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>blockOut <span class="token operator">+</span> out<span class="token punctuation">)</span>
        <span class="token keyword">break</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>blockOut<span class="token punctuation">)</span> <span class="token operator">!=</span> j<span class="token punctuation">:</span>
      oracleBlock<span class="token punctuation">[</span><span class="token operator">-</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> originalOracle<span class="token punctuation">[</span><span class="token operator">-</span>j<span class="token punctuation">]</span>
      intermediates<span class="token punctuation">[</span><span class="token operator">-</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>originalOracle<span class="token punctuation">[</span><span class="token operator">-</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">^</span> j
      blockOut <span class="token operator">=</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token punctuation">[</span> intermediates<span class="token punctuation">[</span><span class="token operator">-</span>j<span class="token punctuation">]</span> <span class="token operator">^</span> <span class="token builtin">int</span><span class="token punctuation">(</span>originalOracle<span class="token punctuation">[</span><span class="token operator">-</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> blockOut
      <span class="token keyword">for</span> h <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">:</span>
        oracleBlock<span class="token punctuation">[</span><span class="token operator">-</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span>h<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"%02x"</span><span class="token operator">%</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>oracleBlock<span class="token punctuation">[</span><span class="token operator">-</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span>h<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">^</span> j <span class="token operator">^</span> <span class="token punctuation">(</span>j<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">print</span><span class="token punctuation">(</span>blockOut <span class="token operator">+</span> out<span class="token punctuation">)</span>
      
  out <span class="token operator">=</span> blockOut <span class="token operator">+</span> out
<span class="token keyword">print</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span>
</code></pre>
<p>This will not give us the entire flag however since the first block has no previous block. Normally we would use the IV as the previous block, but the IV is not available to us to modify. We only get 48 bytes which is 3 blocks, and the bytes we were able to recover fit in the last two of the blocks, <code>4dd1ng_4tt4ck_r0</code> and <code>s3n_b3rg}\x07\x07\x07\x07\x07\x07\x07</code>, meaning the IV is not being sent for us to manipulate. Fortunately the flag prefix is known to be <code>RTXFLAG{</code> 8 bytes, The last 8 bytes are also pretty easy to guess since we have the end.</p>
<p><code>RTXFLAG{0r4cl3_p4dd1ng_4tt4ck_r0s3n_b3rg}</code></p>
</div>
</body>

</html>
